/**
 * ALGORITME COMPLET D'ACCENTUACIÓ CATALANA - VERSIÓ IEC
 * Basat estrictament en les normes de l'Institut d'Estudis Catalans
 * Versió corregida amb regles específiques de semivocals i diftongs
 */

class AccentuacioCatalana {
    
    // Llistes de paraules específiques
    static DIFTONGS_DECREIXENTS = [
        'esglai', 'servei', 'Alcoi', 'biscuit', 'holocaust', 'guineu', 
        'arxiu', 'dinou', 'enduu', 'bungalou', 'commou', 'vei', 'trei', 'crei'
    ];
    
    static TRUNCATS = {
        'estèreo': 'esdrúixol', 'físio': 'esdrúixol', 'súper': 'esdrúixol',
        'micro': 'pla', 'tele': 'pla', 'moto': 'pla', 'bici': 'pla', 
        'foto': 'pla', 'video': 'pla', 'info': 'pla', 'electro': 'pla', 'boli': 'pla'
    };
    
    static EXCEPCIONS_U = [
        'gúa', 'agúo', 'agúes', 'agúa', 'agúen', 'agúis',
        'agüo', 'agües', 'agüa', 'agüen', 'agüis', 'ingúix', 'ingúixia'
    ];

    static HIATS_ESPECIALS = ['aü', 'eü', 'oü', 'aï', 'eï', 'oï'];
    
    static TERMINACIONS_LATINES = ['um', 'us']; // -um, -us (harmònium, Màrius)

    /**
     * FUNCIÓ PRINCIPAL - Analitza una paraula completa
     */
    static analitzarParaula(paraula) {
        if (!paraula || paraula.trim() === '') {
            return { error: 'Paraula buida' };
        }

        // Netejar la paraula
        const neta = paraula.toLowerCase().replace(/[^a-zàèéíïòóúü·\-]/g, '');
        
        // Verificar casos especials per ordre de prioritat
        if (this.esExcepcioU(neta)) {
            return this.analitzarExcepcioU(paraula, neta);
        }
        
        if (this.esAdverbiMent(neta)) {
            return this.analitzarAdverbiMent(paraula, neta);
        }
        
        if (this.esMotAmbGuionet(neta)) {
            return this.analitzarMotAmbGuionet(paraula, neta);
        }
        
        if (this.esMotTruncat(neta)) {
            return this.analitzarMotTruncat(paraula, neta);
        }
        
        if (this.esMotCompost(neta)) {
            return this.analitzarMotCompost(paraula, neta);
        }

        // Mot simple
        return this.analitzarMotSimple(paraula, neta);
    }

    /**
     * SIL·LABIFICACIÓ PRINCIPAL - VERSIÓ IEC CORREGIDA
     */
    static separarSilabes(paraula) {
        const silabes = [];
        let index = 0;
        
        while (index < paraula.length) {
            const silaba = this.obtenirSilaba(paraula, index);
            silabes.push(silaba);
            index += silaba.length;
        }
        
        return silabes;
    }

    static obtenirSilaba(paraula, inici) {
        const resta = paraula.substring(inici);
        
        // REGLA a) - i/u febles entre dues vocals → semivocals
        if (this.esSemivocalEntreVocals(paraula, inici)) {
            // La i/u forma síl·laba amb la vocal següent
            return resta.substring(0, 2);
        }
        
        // Casos especials de i/u (altres situacions)
        if (this.esVocalSeparada(paraula, inici)) {
            return paraula[inici];
        }
        
        // Diftongs i triftongs (no es separen) - amb verificació de hiats
        const diftong = this.obtenirDiftong(resta);
        if (diftong) return diftong;
        
        // Dígrafs que no es separen
        const digraf = this.obtenirDigraf(resta);
        if (digraf) return digraf;
        
        // Grups consonàntics complexes
        const grupConsonantic = this.obtenirGrupConsonantic(resta);
        if (grupConsonantic) return grupConsonantic;
        
        // Consonant + vocal
        if (/^[^aeiouàèéíïòóúü][aeiouàèéíïòóúü]/.test(resta)) {
            return resta.substring(0, 2);
        }
        
        // Vocal sola
        if (/^[aeiouàèéíïòóúü]/.test(resta)) {
            return resta[0];
        }
        
        // Consonant sola
        return resta[0];
    }

    /**
     * REGLA a) - i/u febles entre dues vocals → semivocals
     */
    static esSemivocalEntreVocals(paraula, posicio) {
        const lletra = paraula[posicio];
        if (!'iu'.includes(lletra)) return false;
        
        const anterior = posicio > 0 ? paraula[posicio - 1] : null;
        const seguent = posicio < paraula.length - 1 ? paraula[posicio + 1] : null;
        
        // REGLA a): i/u entre dues vocals → semivocal amb la següent
        if (anterior && 'aeiouàèéíïòóúü'.includes(anterior) &&
            seguent && 'aeiouàèéíïòóúü'.includes(seguent)) {
            return true;
        }
        
        return false;
    }

    /**
     * REGLA b) - i/u febles entre consonant i vocal
     */
    static esVocalSeparada(paraula, posicio) {
        const lletra = paraula[posicio];
        if (!'iu'.includes(lletra)) return false;
        
        const anterior = posicio > 0 ? paraula[posicio - 1] : null;
        const seguent = posicio < paraula.length - 1 ? paraula[posicio + 1] : null;
        
        // REGLA b): i/u entre consonant i vocal → ES SEPARA (esdrúixols)
        if (anterior && !'aeiouàèéníïòóúü'.includes(anterior) && 
            seguent && 'aeiouàèéíïòóúü'.includes(seguent)) {
            
            // EXCEPCIÓ: u després de g/q → NO es separa (diftong)
            if (lletra === 'u' && 'gq'.includes(anterior.toLowerCase())) {
                return false;
            }
            
            // EXCEPCIÓ: u després de c → SÍ es separa (esdrúixol)
            if (lletra === 'u' && anterior.toLowerCase() === 'c') {
                return true;
            }
            
            return true;
        }
        
        return false;
    }

    /**
     * DIFTONGS I HIATS - VERSIÓ IEC
     */
    static obtenirDiftong(resta) {
        // TRIFTONGS - Primer verifiquem els grups de 3 vocals
        if (/^[aeiouàèéíïòóúü][iu][aeiouàèéíïòóúü]/.test(resta)) {
            const match = resta.match(/^[aeiouàèéíïòóúü][iu][aeiouàèéíïòóúü]/)[0];
            // VERIFICAR SI ÉS HIAT
            if (!this.esHiat(match)) {
                return match;
            }
        }
        
        // DIFTONGS CREIXENTS - i/u + vocal forta
        if (/^[iu][aeiouàèéíïòóúü]/.test(resta)) {
            const match = resta.match(/^[iu][aeiouàèéíïòóúü]/)[0];
            if (!this.esHiat(match)) {
                return match;
            }
        }
        
        // DIFTONGS DECREIXENTS - vocal forta + i/u (REGLA c)
        if (/^[aeiouàèéíïòóúü][iu]/.test(resta)) {
            const match = resta.match(/^[aeiouàèéíïòóúü][iu]/)[0];
            // REGLA c): Verificar excepcions
            if (!this.esHiat(match) && !this.esExcepcioDiftongDecreixent(resta)) {
                return match;
            }
        }
        
        return null;
    }

    /**
     * REGLA c) - Excepcions de diftongs decreixents
     */
    static esExcepcioDiftongDecreixent(resta) {
        // Present de subjuntiu: -i, -is, -in
        if (/^(i|is|in)$/.test(resta)) {
            return true;
        }
        
        // Terminacions llatines -um, -us
        if (this.TERMINACIONS_LATINES.some(terminacio => resta.endsWith(terminacio))) {
            return true;
        }
        
        return false;
    }

    /**
     * DETECTAR HIATS
     */
    static esHiat(grupVocals) {
        const paraula = grupVocals.toLowerCase();
        
        // Casos especials amb dièresi (es separen)
        if (this.HIATS_ESPECIALS.includes(paraula)) {
            return true;
        }
        
        // Vocal tònica seguida de vocal àtona → hiat
        if (/[àèéíïòóúü][aeiou]/.test(paraula)) {
            return true;
        }
        
        // Vocal àtona seguida de vocal tònica → hiat  
        if (/[aeiou][àèéíïòóúü]/.test(paraula)) {
            return true;
        }
        
        // Dos vocals fortes (a, e, o) → hiat
        if (/[aeo][aeo]/.test(paraula)) {
            return true;
        }
        
        return false;
    }

    /**
     * DETERMINACIÓ DEL TIPUS D'ACCENTUACIÓ
     */
    static determinarTipusAccentuacio(paraula) {
        const silabes = this.separarSilabes(paraula.toLowerCase());
        
        if (silabes.length <= 1) return 'monosillab';
        
        // Buscar síl·laba tònica per accent gràfic
        for (let i = 0; i < silabes.length; i++) {
            if (/[àèéíïòóúü]/.test(silabes[i])) {
                if (i === silabes.length - 1) return 'agut';
                if (i === silabes.length - 2) return 'pla';
                return 'esdruixol';
            }
        }
        
        // Sense accent gràfic - aplicar regles generals
        const ultima = silabes[silabes.length - 1];
        
        // Aguts: acaben en vocal, vocal+s, -en, -in (excepte diftongs decreixents)
        if (this.esTerminacioAguda(ultima) && !this.esDiftongDecreixent(paraula)) {
            return 'agut';
        }
        
        // Per defecte: pla
        return 'pla';
    }

    /**
     * FUNCIONS AUXILIARS
     */
    static obtenirDigraf(resta) {
        const digrafs = [/^gu[aeiou]/, /^qu[aeiou]/, /^ll/, /^ny/, /^ix/, /^rr/, /^ss/];
        for (const digraf of digrafs) {
            const match = resta.match(digraf);
            if (match) return match[0];
        }
        return null;
    }

    static obtenirGrupConsonantic(resta) {
        const grups = ['bl', 'br', 'cl', 'cr', 'dr', 'fl', 'fr', 'gl', 'gr', 'pl', 'pr', 'tr'];
        for (const grup of grups) {
            if (resta.startsWith(grup)) {
                return grup;
            }
        }
        return null;
    }

    static esTerminacioAguda(silaba) {
        return /^[aeiou]s?$|en$|in$/.test(silaba);
    }

    static esDiftongDecreixent(paraula) {
        return this.DIFTONGS_DECREIXENTS.some(diftong => 
            paraula.toLowerCase().endsWith(diftong)
        );
    }

    /**
     * CASOS ESPECIALS (sense canvis)
     */
    static esExcepcioU(paraula) {
        return this.EXCEPCIONS_U.includes(paraula.toLowerCase());
    }

    static analitzarExcepcioU(original, neta) {
        let silabes;
        
        switch(neta) {
            case 'gúa': silabes = ['gú', 'a']; break;
            case 'ingúix': silabes = ['in', 'gúix']; break;
            case 'ingúixia': silabes = ['in', 'gúi', 'xi', 'a']; break;
            default: 
                silabes = ['a', neta.substring(1, 4), neta.substring(4)].filter(s => s);
        }
        
        return {
            paraula: original,
            silabes: silabes,
            tipusAccentuacio: this.determinarTipusAccentuacio(original),
            esExcepcio: true,
            observacions: "Cas excepcional - u tònica precedida de g"
        };
    }

    static esAdverbiMent(paraula) {
        return paraula.endsWith('ment') && paraula.length > 4;
    }

    static analitzarAdverbiMent(original, neta) {
        const base = neta.slice(0, -4);
        return {
            paraula: original,
            silabes: this.separarSilabes(neta),
            tipusAccentuacio: this.determinarTipusAccentuacio(neta),
            esAdverbiMent: true,
            base: base,
            basePortaAccent: /[àèéíïòóúü]/.test(base),
            observacions: "Adverbi en -ment manté l'accent del component de l'esquerra"
        };
    }

    static esMotAmbGuionet(paraula) {
        return paraula.includes('-');
    }

    static analitzarMotAmbGuionet(original, neta) {
        const parts = neta.split('-');
        const partsAnalitzades = parts.map(part => ({
            part: part,
            silabes: this.separarSilabes(part),
            tipus: this.determinarTipusAccentuacio(part),
            portaAccent: /[àèéíïòóúü]/.test(part)
        }));
        
        return {
            paraula: original,
            parts: partsAnalitzades,
            esCompostAmbGuionet: true,
            observacions: "Cada component manté la seva accentuació"
        };
    }

    static esMotTruncat(paraula) {
        return Object.keys(this.TRUNCATS).includes(paraula.toLowerCase());
    }

    static analitzarMotTruncat(original, neta) {
        return {
            paraula: original,
            silabes: this.separarSilabes(neta),
            tipusAccentuacio: this.TRUNCATS[neta],
            esTruncat: true,
            observacions: "Mot truncat - accent independent de l'original"
        };
    }

    static esMotCompost(paraula) {
        const prefixos = ['auto', 'anti', 'bi', 'co', 'contra', 'des', 'dis', 'en', 'ex', 'extra',
                         'hiper', 'inter', 'macro', 'micro', 'multi', 'poli', 'post', 'pre', 
                         're', 'semi', 'sub', 'super', 'tele', 'trans', 'ultra'];
        
        return prefixos.some(prefix => 
            paraula.toLowerCase().startsWith(prefix) && paraula.length > prefix.length
        );
    }

    static analitzarMotCompost(original, neta) {
        return {
            paraula: original,
            silabes: this.separarSilabes(neta),
            tipusAccentuacio: this.determinarTipusAccentuacio(neta),
            esCompost: true,
            observacions: "Mot compost - un sol accent al component de la dreta"
        };
    }

    static analitzarMotSimple(original, neta) {
        const silabes = this.separarSilabes(neta);
        const tipus = this.determinarTipusAccentuacio(neta);
        
        const resultat = {
            paraula: original,
            silabes: silabes,
            tipusAccentuacio: tipus,
            esSimple: true
        };
        
        // Afegir observacions específiques segons regles aplicades
        if (this.haAplicatReglaA(original)) {
            resultat.observacions = "i/u feble entre vocals → semivocal amb vocal següent";
        }
        
        return resultat;
    }
    
    static haAplicatReglaA(paraula) {
        const silabes = this.separarSilabes(paraula);
        return silabes.some(silaba => /[iu][aeiou]/.test(silaba) && silaba.length === 2);
    }
}

/**
 * FUNCIÓ D'ÚS RÀPID
 */
function analitzarAccentuacio(paraula) {
    return AccentuacioCatalana.analitzarParaula(paraula);
}

// TEST DE LA VERSIÓ IEC CORREGIDA
console.log("=== TEST VERSIÓ IEC CORREGIDA ===");
console.log(analitzarAccentuacio("noia"));        // ["no", "ia"] ✓
console.log(analitzarAccentuacio("xemeneia"));    // ["xe", "me", "ne", "ia"] ✓
console.log(analitzarAccentuacio("boscúria"));    // ["bos", "cú", "ri", "a"] ✓
console.log(analitzarAccentuacio("llengua"));     // ["llen", "gua"] ✓
console.log(analitzarAccentuacio("vàcua"));       // ["và", "cu", "a"] ✓
console.log(analitzarAccentuacio("esglai"));      // ["es", "glai"] ✓
console.log(analitzarAccentuacio("creï"));        // ["cre", "ï"] ✓ (excepció)

// Export per a ús en diferents entorns
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { AccentuacioCatalana, analitzarAccentuacio };
}
