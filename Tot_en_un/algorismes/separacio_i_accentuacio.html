/**
 * ALGORITME COMPLET D'ACCENTUACIÓ CATALANA
 * Basat en les normes de l'Institut d'Estudis Catalans
 */

class AccentuacioCatalana {
    
    // Llistes de paraules específiques
    static DIFTONGS_DECREIXENTS = [
        'espai', 'servei', 'avui', 'complau', 'heroi', 'novel', 'mireu', 
        'dinou', 'enduu', 'bungalou', 'commou', 'vei', 'trei', 'crei'
    ];
    
    static TRUNCATS = {
        'estèreo': 'esdrúixol', 'físio': 'esdrúixol', 'súper': 'esdrúixol',
        'micro': 'pla', 'tele': 'pla', 'moto': 'pla', 'bici': 'pla', 
        'foto': 'pla', 'video': 'pla', 'info': 'pla', 'electro': 'pla', 'boli': 'pla'
    };
    
    static EXCEPCIONS_U = [
        'gúa', 'agúo', 'agúes', 'agúa', 'agúen', 'agúis',
        'agüo', 'agües', 'agüa', 'agüen', 'agüis', 'ingúix', 'ingúixia'
    ];

    /**
     * FUNCIÓ PRINCIPAL - Analitza una paraula completa
     */
    static analitzarParaula(paraula) {
        if (!paraula || paraula.trim() === '') {
            return { error: 'Paraula buida' };
        }

        // Netejar la paraula
        const neta = paraula.toLowerCase().replace(/[^a-zàèéíïòóúü·\-]/g, '');
        
        // Verificar casos especials per ordre de prioritat
        if (this.esExcepcioU(neta)) {
            return this.analitzarExcepcioU(paraula, neta);
        }
        
        if (this.esAdverbiMent(neta)) {
            return this.analitzarAdverbiMent(paraula, neta);
        }
        
        if (this.esMotAmbGuionet(neta)) {
            return this.analitzarMotAmbGuionet(paraula, neta);
        }
        
        if (this.esMotTruncat(neta)) {
            return this.analitzarMotTruncat(paraula, neta);
        }
        
        if (this.esMotCompost(neta)) {
            return this.analitzarMotCompost(paraula, neta);
        }

        // Mot simple
        return this.analitzarMotSimple(paraula, neta);
    }

    /**
     * SIL·LABIFICACIÓ PRINCIPAL
     */
    static separarSilabes(paraula) {
        const silabes = [];
        let index = 0;
        
        while (index < paraula.length) {
            const silaba = this.obtenirSilaba(paraula, index);
            silabes.push(silaba);
            index += silaba.length;
        }
        
        return silabes;
    }

    static obtenirSilaba(paraula, inici) {
        const resta = paraula.substring(inici);
        
        // Casos especials de i/u
        if (this.esVocalSeparada(paraula, inici)) {
            return paraula[inici];
        }
        
        // Diftongs i triftongs (no es separen)
        const diftong = this.obtenirDiftong(resta);
        if (diftong) return diftong;
        
        // Dígrafs que no es separen
        const digraf = this.obtenirDigraf(resta);
        if (digraf) return digraf;
        
        // Grups consonàntics complexes
        const grupConsonantic = this.obtenirGrupConsonantic(resta);
        if (grupConsonantic) return grupConsonantic;
        
        // Consonant + vocal
        if (/^[^aeiouàèéíïòóúü][aeiouàèéíïòóúü]/.test(resta)) {
            return resta.substring(0, 2);
        }
        
        // Vocal sola
        if (/^[aeiouàèéíïòóúü]/.test(resta)) {
            return resta[0];
        }
        
        // Consonant sola
        return resta[0];
    }

    /**
     * DETERMINACIÓ DEL TIPUS D'ACCENTUACIÓ
     */
    static determinarTipusAccentuacio(paraula) {
        const silabes = this.separarSilabes(paraula.toLowerCase());
        
        if (silabes.length <= 1) return 'monosillab';
        
        // Buscar síl·laba tònica per accent gràfic
        for (let i = 0; i < silabes.length; i++) {
            if (/[àèéíïòóúü]/.test(silabes[i])) {
                if (i === silabes.length - 1) return 'agut';
                if (i === silabes.length - 2) return 'pla';
                return 'esdruixol';
            }
        }
        
        // Sense accent gràfic - aplicar regles generals
        const ultima = silabes[silabes.length - 1];
        
        // Aguts: acaben en vocal, vocal+s, -en, -in (excepte diftongs decreixents)
        if (this.esTerminacioAguda(ultima) && !this.esDiftongDecreixent(ultima)) {
            return 'agut';
        }
        
        // Per defecte: pla
        return 'pla';
    }

    /**
     * FUNCIONS AUXILIARS
     */
    static esVocalSeparada(paraula, posicio) {
        const lletra = paraula[posicio];
        if (!'iu'.includes(lletra)) return false;
        
        const anterior = posicio > 0 ? paraula[posicio - 1] : null;
        const seguent = posicio < paraula.length - 1 ? paraula[posicio + 1] : null;
        
        // i/u entre consonant i vocal → es separa
        if (anterior && !'aeiouàèéíïòóúü'.includes(anterior) && 
            seguent && 'aeiouàèéíïòóúü'.includes(seguent)) {
            // Excepció: u després de g/q
            if (lletra === 'u' && 'gq'.includes(anterior.toLowerCase())) {
                return false;
            }
            return true;
        }
        
        return false;
    }

    static obtenirDiftong(resta) {
        // Triftongs
        if (/^[aeiouàèéíïòóúü][iu][aeiouàèéíïòóúü]/.test(resta)) {
            return resta.match(/^[aeiouàèéíïòóúü][iu][aeiouàèéíïòóúü]/)[0];
        }
        
        // Diftongs creixents
        if (/^[iu][aeiouàèéíïòóúü]/.test(resta)) {
            return resta.match(/^[iu][aeiouàèéíïòóúü]/)[0];
        }
        
        // Diftongs decreixents
        if (/^[aeiouàèéíïòóúü][iu]/.test(resta)) {
            return resta.match(/^[aeiouàèéíïòóúü][iu]/)[0];
        }
        
        return null;
    }

    static obtenirDigraf(resta) {
        const digrafs = [/^gu[aeiou]/, /^qu[aeiou]/, /^ll/, /^ny/, /^ix/, /^rr/, /^ss/];
        for (const digraf of digrafs) {
            const match = resta.match(digraf);
            if (match) return match[0];
        }
        return null;
    }

    static obtenirGrupConsonantic(resta) {
        const grups = ['bl', 'br', 'cl', 'cr', 'dr', 'fl', 'fr', 'gl', 'gr', 'pl', 'pr', 'tr'];
        for (const grup of grups) {
            if (resta.startsWith(grup)) {
                return grup;
            }
        }
        return null;
    }

    static esTerminacioAguda(silaba) {
        return /^[aeiou]s?$|en$|in$/.test(silaba);
    }

    static esDiftongDecreixent(silaba) {
        return this.DIFTONGS_DECREIXENTS.some(diftong => 
            silaba.toLowerCase().endsWith(diftong) || diftong.endsWith(silaba.toLowerCase())
        );
    }

    /**
     * CASOS ESPECIALS
     */
    static esExcepcioU(paraula) {
        return this.EXCEPCIONS_U.includes(paraula.toLowerCase());
    }

    static analitzarExcepcioU(original, neta) {
        let silabes;
        
        switch(neta) {
            case 'gúa': silabes = ['gú', 'a']; break;
            case 'ingúix': silabes = ['in', 'gúix']; break;
            case 'ingúixia': silabes = ['in', 'gúi', 'xi', 'a']; break;
            default: 
                // Formes d'aguar: a-gú-o, a-gú-es, etc.
                silabes = ['a', neta.substring(1, 4), neta.substring(4)].filter(s => s);
        }
        
        return {
            paraula: original,
            silabes: silabes,
            tipusAccentuacio: this.determinarTipusAccentuacio(original),
            esExcepcio: true,
            observacions: "Cas excepcional - u tònica precedida de g"
        };
    }

    static esAdverbiMent(paraula) {
        return paraula.endsWith('ment') && paraula.length > 4;
    }

    static analitzarAdverbiMent(original, neta) {
        const base = neta.slice(0, -4);
        return {
            paraula: original,
            silabes: this.separarSilabes(neta),
            tipusAccentuacio: this.determinarTipusAccentuacio(neta),
            esAdverbiMent: true,
            base: base,
            basePortaAccent: /[àèéíïòóúü]/.test(base),
            observacions: "Adverbi en -ment manté l'accent del component de l'esquerra"
        };
    }

    static esMotAmbGuionet(paraula) {
        return paraula.includes('-');
    }

    static analitzarMotAmbGuionet(original, neta) {
        const parts = neta.split('-');
        const partsAnalitzades = parts.map(part => ({
            part: part,
            silabes: this.separarSilabes(part),
            tipus: this.determinarTipusAccentuacio(part),
            portaAccent: /[àèéíïòóúü]/.test(part)
        }));
        
        return {
            paraula: original,
            parts: partsAnalitzades,
            esCompostAmbGuionet: true,
            observacions: "Cada component manté la seva accentuació"
        };
    }

    static esMotTruncat(paraula) {
        return Object.keys(this.TRUNCATS).includes(paraula.toLowerCase());
    }

    static analitzarMotTruncat(original, neta) {
        return {
            paraula: original,
            silabes: this.separarSilabes(neta),
            tipusAccentuacio: this.TRUNCATS[neta],
            esTruncat: true,
            observacions: "Mot truncat - accent independent de l'original"
        };
    }

    static esMotCompost(paraula) {
        const prefixos = ['auto', 'anti', 'bi', 'co', 'contra', 'des', 'dis', 'en', 'ex', 'extra',
                         'hiper', 'inter', 'macro', 'micro', 'multi', 'poli', 'post', 'pre', 
                         're', 'semi', 'sub', 'super', 'tele', 'trans', 'ultra'];
        
        return prefixos.some(prefix => 
            paraula.toLowerCase().startsWith(prefix) && paraula.length > prefix.length
        );
    }

    static analitzarMotCompost(original, neta) {
        return {
            paraula: original,
            silabes: this.separarSilabes(neta),
            tipusAccentuacio: this.determinarTipusAccentuacio(neta),
            esCompost: true,
            observacions: "Mot compost - un sol accent al component de la dreta"
        };
    }

    static analitzarMotSimple(original, neta) {
        return {
            paraula: original,
            silabes: this.separarSilabes(neta),
            tipusAccentuacio: this.determinarTipusAccentuacio(neta),
            esSimple: true
        };
    }
}

/**
 * FUNCIÓ D'ÚS RÀPID
 */
function analitzarAccentuacio(paraula) {
    return AccentuacioCatalana.analitzarParaula(paraula);
}

// Export per a ús en diferents entorns
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { AccentuacioCatalana, analitzarAccentuacio };
}
